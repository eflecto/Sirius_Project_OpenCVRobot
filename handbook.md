# Handbook: Алгоритмы детектирования и трекинга по цвету одежды

Этот документ подробно объясняет принципы работы алгоритмов в проекте, охватывая этапы от захвата цвета и построения маски до вычисления координат для робота, а также модуль скелетизации силуэта.

## 1. Базовые понятия

- `HSV` пространство: разделяет цвет на тон (`H`), насыщенность (`S`) и яркость (`V`).
- Маска: бинарное изображение, где пиксели, соответствующие целевому диапазону цвета, помечены как 1 (255), остальное — 0.
- Контур: набор точек, описывающих границу связной области на маске.
- `bbox` (bounding box): минимальный ограничивающий прямоугольник для контура.

## 2. Захват эталонного цвета

При старте трекинга пользователь помещает одежду в центральный ROI, после чего:
- Кадр преобразуется из `BGR` в `HSV`.
- Оценивается цвет внутри ROI.
  - В `robust_clothing_tracker.py` используется комбинация методов:
    - Пик гистограммы по компоненте `Hue` (выбор доминирующего тона).
    - Среднее и медиана по `S` и `V` (устойчивость к бликам/теням).
  - В простых скриптах — среднее по ROI.

### Адаптация диапазонов

- Диапазоны `H±h_range`, `S±s_range`, `V±v_range` настраиваются по разбросу (стандартному отклонению) значений в ROI.
- Чем выше разброс, тем шире диапазоны, чтобы не потерять цель.
- Наоборот, при стабильном цвете есть смысл сузить диапазоны для снижения ложных срабатываний.

## 3. Построение маски по цвету

Создание маски — функция `cv2.inRange(hsv, lower, upper)`, где:
- `lower = [H - h_range, S - s_range, V - v_range]`
- `upper = [H + h_range, S + s_range, V + v_range]`

Особенность: компонент `Hue` цикличен на отрезке `[0, 179]`. Для красных оттенков диапазон может пересекать границы 0/179. В `robust_clothing_tracker.py` это учтено — диапазон разбивается на две части и объединяется через `bitwise_or`.

## 4. Морфологическая очистка

Цель морфологии — улучшить маску перед поиском контуров:
- `OPEN` (эрозия → дилатация) удаляет мелкие шумы.
- `CLOSE` (дилатация → эрозия) заполняет мелкие разрывы внутри объекта.
- `medianBlur` сглаживает границы маски.

Параметры ядра и количество итераций выбираются как компромисс между очисткой и сохранением формы.

## 5. Поиск и фильтрация контуров

- Контуры ищутся с помощью `cv2.findContours(..., RETR_EXTERNAL, ...)`.
- Первичная фильтрация по площади: отбрасываются слишком маленькие области.
- Дополнительные эвристики:
  - Соотношение сторон bbox (человек обычно «выше, чем шире»).
  - Близость к последней известной позиции (в `clothing_tracker(1).py`) — стабилизирует выбор целевого контура.

## 6. Геометрические параметры цели

- Центр масс контура (`cv2.moments`) — устойчивый способ получить координаты цели.
- Оценка расстояния по ширине bbox: `distance ≈ (real_width * focal_length) / pixel_width`.
  - `real_width` — априорная реальная ширина торса (45–50 см).
  - `focal_length` — калиброванное фокусное расстояние в пикселях.
- Угол до цели: по горизонтальному смещению центра относительно центра кадра.

## 7. Координаты в системе робота

Преобразование в плоские координаты:
- `x_robot = distance * sin(angle)` — боковое смещение.
- `y_robot = distance * cos(angle)` — продольная дистанция.
- `theta = angle` — требуемый поворот.

Альтернативно, в `clothing_tracker(1).py` используется модель с учетом поля зрения (`FOV`): углы рассчитываются из нормированного смещения пикселя и масштабируются на `FOV`.

## 8. Фильтр Калмана (стабилизация трека)

Используется в `clothing_tracker(1).py` для плавного предсказания положения:
- Вектор состояния: `[x, y, vx, vy]`.
- Матрица перехода `F` учитывает постоянную скорость между кадрами.
- При потере цели короткое время используется `predict()` для отображения предполагаемой позиции.

Плюсы: устойчивость к кратковременным пропускам; минусы: требуется разумная настройка ковариаций шума.

## 9. Траектория и визуализация

- Хранится история центров цели, рисуются линии с градиентом толщины.
- Инфо-блок показывает ключевые метрики: расстояние, угол, координаты робота, «уверенность» (площадь контура).
- Мини-карта «MASK»/«TOP VIEW» помогает оперативно диагностировать качество сегментации и относительное положение цели.

## 10. Скелетизация силуэта

Модуль `skeletonization.py` предназначен для получения тонкой структуры силуэта.

### Конвейер подготовки маски

1. Грейскейл + `CLAHE` (локальное выравнивание яркости).
2. `HOG+SVM` (опционально) для нахождения ROI с человеком.
3. Бинаризация (`OTSU` или фиксированный порог).
4. Объединение пороговой маски и границ (`Canny`).
5. Морфология `OPEN/CLOSE` и заполнение контуров.

### Скелетизация

- `ximgproc.thinning` (алгоритм Zhang–Suen) — быстрый и качественный метод, если модуль доступен.
- Морфологическая альтернатива: итеративная эрозия + открытие, добавление разницы в скелет до полного исчезновения пикселей.

### Наложение результата

Полученный скелет окрашивается и накладывается поверх исходного кадра с коэффициентом `alpha` для наглядности.

## 11. Калибровка камеры

Точность оценки расстояния сильно зависит от `focal_length`:
- Проведите калибровку на известной ширине объекта на фиксированном расстоянии.
- Получите коэффициент, при котором формула `distance ≈ (real_width * focal_length) / pixel_width` дает корректные значения.

## 12. Производительность и устойчивость

- Размытие и морфология улучшают устойчивость, но добавляют задержку — ищите баланс.
- Уменьшение разрешения кадра ускоряет работу, но снижает точность измерений.
- Адаптивные диапазоны по статистике ROI помогают в сложном освещении.

## 13. Частые проблемы и решения

1) Не детектируется цель:
- Увеличьте диапазоны `S`/`V`.
- Проверьте освещение и избегайте бликов.
- Используйте `robust_clothing_tracker.py` с адаптацией диапазонов.

2) Много ложных срабатываний:
- СуЗьте диапазоны HSV.
- Поднимите минимальную площадь контура.
- Добавьте фильтр по соотношению сторон bbox.

3) Цель часто теряется при движении:
- Увеличьте окно допустимой потери (`max_lost_frames`).
- Включите фильтр Калмана.
- Расширьте `V`-диапазон (чувствительность к яркости).

## 14. Практические советы

- Для тестов используйте яркую однотонную одежду, контрастную к фону.
- Избегайте сложных узоров, камуфляжа и блестящих тканей.
- Держите цель в центре при захвате цвета для лучшей статистики.

## 15. Интеграция с робототехнической системой

- Координаты `(x_robot, y_robot, theta)` могут напрямую подаваться в модуль навигации.
- Рекомендуется фильтровать/сглаживать команды, учитывая частоту кадров и задержки.
- При потере цели используйте предсказание и поиск в последней известной окрестности.

---

Этот справочник дополняет краткий `README.md` и предназначен для глубокого понимания алгоритмов, их параметров и типовых сценариев адаптации под конкретные условия.