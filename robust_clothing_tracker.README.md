# Robust Clothing Tracker — подробный README

Этот документ описывает работу скрипта `robust_clothing_tracker.py`: цели, запуск, управление, алгоритмы, настройку и диагностику.

## Назначение
- Робастное отслеживание человека по цвету одежды с автоматической адаптацией диапазонов HSV и устойчивой визуализацией.

## Требования и запуск
- Python `3.8+`, OpenCV `4.x` (`pip install opencv-python`).
- Подключенная камера.
- Запуск: `python robust_clothing_tracker.py`.

## Управление
- `SPACE` — захват цвета из центрального ROI.
- `+`/`-` — увеличить/уменьшить чувствительность (диапазоны H/S/V).
- `[`/`]` — уменьшить/увеличить силу коррекции дисторсии (undistort scale).
- `d` — включить/выключить коррекцию дисторсии.
- `c` — калибровка по реальной сцене (см. раздел ниже).
- `r` — сброс трекера (цвет, траектория, калибровка).
- `q` — выход.

## Пошаговый алгоритм
1. Захват цвета и адаптация диапазонов (`robust_clothing_tracker.py:70`).
   - В центральном ROI строится гистограмма компоненты `Hue`; выбирается доминирующий тон.
   - `S` и `V` оцениваются как среднее между mean и median для устойчивости к бликам/теням.
   - Диапазоны `h_range/s_range/v_range` выставляются по стандартному отклонению внутри ROI.
2. Построение маски (`robust_clothing_tracker.py:132`).
   - Формируются пороги `lower/upper` с `clip` в пределах допустимых значений HSV.
   - Обрабатывается цикличность `Hue` около 0/179 для красных оттенков (объединение двух масок).
3. Морфологическая очистка (`robust_clothing_tracker.py:173`).
   - `OPEN` удаляет мелкие шумы; `CLOSE` закрывает отверстия; `medianBlur` сглаживает края.
4. Поиск и фильтрация контуров (`robust_clothing_tracker.py:185`).
   - Отбрасываются малые области; проверяется аспект-рацио bbox (человек «выше, чем шире»).
   - Выбирается самый крупный валидный контур.
5. Геометрия и метрики (`robust_clothing_tracker.py:208`).
   - Центр масс по моментам; ширина bbox.
   - Расстояние: `distance_m ≈ (person_width_cm * focal_length) / (bbox_width * 100)`.
   - Угол: `atan((cx - w/2) / focal_length)`; координаты робота: `x=distance*sin(angle)`, `y=distance*cos(angle)`.
6. Обработка потери цели (`robust_clothing_tracker.py:276`).
   - Счетчик потери; визуализация последней позиции; `TARGET LOST` при длительной потере.
7. Визуализация (`robust_clothing_tracker.py:241`).
   - Контур, bbox, центр; траектория с градиентом толщины; инфо-блок; мини-карта маски.

## Настройка параметров
- `focal_length` (пиксели): калибруется по известной ширине на известной дистанции (`robust_clothing_tracker.py:57`).
- `person_width_cm`: средняя ширина торса, по умолчанию `45` см.
- Диапазоны `h/s/v_range`: автоматически подбираются, можно корректировать вручную (`+`/`-`).

## Калибровка по реальной сцене (D_ref)
- Поставьте человека на примерное расстояние `D_ref` (метры).
- Запустите трекер, захватите цвет (`SPACE`) и убедитесь, что bbox стабилен.
- Нажмите `c` → в консоли введите `D_ref`.
- Трекер сохранит: `ref_distance_m = D_ref`, `ref_bbox_w`, `ref_bbox_h` — текущие ширина/высота bbox (пиксели).
- Дальнейший расчёт расстояния ведётся только относительно эталона:
  - `D_w = D_ref * (w_ref / w)`
  - `D_h = D_ref * (h_ref / h)`
  - Итоговая оценка: `D = (D_w + D_h) / 2`
- Сброс калибровки: при `r` и при новом захвате цвета (`SPACE`).
- Реализация: ввод `D_ref` и сохранение эталона — `robust_clothing_tracker.py:370`; расчёт — `robust_clothing_tracker.py:241`; сброс при новом цвете — `robust_clothing_tracker.py:451`; сброс клавишей `r` — `robust_clothing_tracker.py:777`.

## Чувствительность и устойчивость
- Широкие диапазоны — выше устойчивость к освещению, но больше ложных срабатываний.
- Узкие диапазоны — меньше шумов, но выше риск потери цели.
- Изменения подтверждаются сообщениями в консоли.

## Диагностика
- Мини-карта «Mask» в правом нижнем углу — текущая сегментация.
- Инфо-блок: дистанция, угол, координаты робота, «confidence» (площадь контура).

## Производительность
- Размытие и морфология повышают качество маски, но требуют времени.
- Уменьшение разрешения кадра ускоряет работу, уменьшает шумы, но снижает точность измерений.

## Частые проблемы и решения
1) Не захватывается цвет:
   - Убедитесь, что одежда в центре ROI; освещение ровное.
   - При необходимости увеличьте `s_range/v_range`.
2) Много ложных срабатываний:
   - СуЗьте диапазоны HSV; увеличьте порог минимальной площади контура.
   - Проверяйте фон на похожие цвета.
3) Частая потеря цели при движении:
   - Увеличьте `max_lost_frames`; расширьте `V`-диапазон.

## Совместимость камеры (Windows)
- В случае проблем с захватом видео используйте альтернативные бэкенды (`CAP_DSHOW`, `CAP_MSMF`, `CAP_VFW`) по аналогии с `skeletonization.py:126`.

## Ссылки на ключевые участки кода
- Захват и адаптация цвета: `d:\Mobile_robot\Sirius_Project_OpenCVRobot\robust_clothing_tracker.py:408`.
- Маска с цикличным Hue: `d:\Mobile_robot\Sirius_Project_OpenCVRobot\robust_clothing_tracker.py:460`.
- Расчёт расстояния/угла: `d:\Mobile_robot\Sirius_Project_OpenCVRobot\robust_clothing_tracker.py:241`.
- Обработка клавиш (SPACE, +/-, [, ], d, c, r): `d:\Mobile_robot\Sirius_Project_OpenCVRobot\robust_clothing_tracker.py:753`.
- Калибровка по сцене (ввод D_ref, w_ref, h_ref): `d:\Mobile_robot\Sirius_Project_OpenCVRobot\robust_clothing_tracker.py:370`.
